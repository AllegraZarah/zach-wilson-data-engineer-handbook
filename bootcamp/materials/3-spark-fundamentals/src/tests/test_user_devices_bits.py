from chispa.dataframe_comparer import assert_df_equality
from ..jobs.user_devices_bits_job import do_user_devices_bits_transformation
from collections import namedtuple
from pyspark.sql import SparkSession

UserDevicesCumulated = namedtuple("UserDevicesCumulated", "user_id device_id browser_type device_activity_datelist date")
DeviceBits = namedtuple("DeviceBits", "user_id device_id browser_type datelist_int date")

def test_user_devices_bits(spark):
    # Sample input data
    input_data = [
        UserDevicesCumulated(
            "10060569187331700000",
            "10598707916011500000",
            "Googlebot",
            ["2023-01-01", "2023-01-02", "2023-01-04", "2023-01-05", "2023-01-28", "2023-01-30"],
            "2023-01-31"
        )
    ]

    # Create DataFrame
    input_df = spark.createDataFrame(input_data)

    # Register DataFrame as a temporary view
    input_df.createOrReplaceTempView("user_devices_cumulated")

    # Print input DataFrame for debugging
    input_df.show()

    # Run the transformation
    actual_df = do_user_devices_bits_transformation(spark, input_df)

    # Print actual DataFrame for debugging
    actual_df.show()

    # Expected output data
    expected_data = [
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000100","2023-01-01"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000001000","2023-01-02"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-03"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000100000","2023-01-04"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000001000000","2023-01-05"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-06"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-07"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-08"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-09"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-10"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-11"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-12"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-13"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-14"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-15"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-16"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-17"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-18"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-19"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-20"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-21"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-22"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-23"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-24"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-25"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-26"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-27"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00100000000000000000000000000000","2023-01-28"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-29"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","10000000000000000000000000000000","2023-01-30"),
        DeviceBits("10060569187331700000","10598707916011500000","Googlebot","00000000000000000000000000000000","2023-01-31")
    ]

    expected_df = spark.createDataFrame(expected_data)

    # Assert the results
    assert_df_equality(actual_df, expected_df, ignore_nullable=True)